From: Danny Kukawka <dkukawka@suse.de>
Date: Thu, 5 Jun 2014 00:06:53 +0200
Subject: [PATCH] mkcephfs: add xfs support

Merge distro patches to git.

This was ceph-mkcephfs.add.xfs.support.diff
---
 src/mkcephfs.in | 51 ++++++++++++++++++++++++++-------------------------
 1 file changed, 26 insertions(+), 25 deletions(-)

diff --git a/src/mkcephfs.in b/src/mkcephfs.in
index 2838568..baf4e88 100644
--- a/src/mkcephfs.in
+++ b/src/mkcephfs.in
@@ -62,7 +62,7 @@ else
 fi
 
 usage_exit() {
-    echo "usage: $0 -a -c ceph.conf [-k adminkeyring] [--mkfs]"
+    echo "usage: $0 -a -c ceph.conf [-k adminkeyring] [--mkbtrfs|--mkxfs]"
     echo "   to generate a new ceph cluster on all nodes; for advanced usage see man page"
     echo "   ** be careful, this WILL clobber old data; check your ceph.conf carefully **"
     exit
@@ -73,6 +73,7 @@ usage_exit() {
 
 allhosts=0
 mkfs=0
+mkxfs=0
 preparemonmap=0
 prepareosdfs=""
 initdaemon=""
@@ -135,6 +136,10 @@ case $1 in
     --mkbtrfs | --mkfs)
 	    mkfs=1
 	    ;;
+    --mkxfs)
+	    mkbtrfs=0
+	    mkxfs=1
+	    ;;
     --no-copy-conf)
 	    nocopyconf=1
 	    ;;
@@ -310,33 +315,30 @@ if [ -n "$prepareosdfs" ]; then
 
     get_conf osd_data "/var/lib/ceph/osd/ceph-$id" "osd data"
     get_conf osd_journal "$osd_data/journal" "osd journal"
-    get_conf fs_path "$osd_data" "fs path"  # mount point defaults so osd data
-    get_conf fs_devs "" "devs"
-    get_conf fs_type "" "osd mkfs type"
-
+    fs_path=
+    fs_devs=
+    fs_opt=
+    fs_is_btrfs=1
+    fs_is_xfs=0
+    get_conf fs_path "$osd_data" "btrfs path"  # mount point defaults so osd data
+    get_conf fs_devs "" "btrfs devs"
+    get_conf fs_opt "noatime" "btrfs options"
+	
     if [ -z "$fs_devs" ]; then
-	# try to fallback to old keys
-        get_conf tmp_btrfs_devs "" "btrfs devs"
-        if [ -n "$tmp_btrfs_devs" ]; then
-            fs_devs="$tmp_btrfs_devs"
-        else
-            echo "no devs defined for $name"
-            exit 1
-        fi
+	echo "Check for XFS settings ..."
+	get_conf fs_path "$osd_data" "xfs path"  # mount point defaults so osd data
+        get_conf fs_devs "" "xfs devs"
+	get_conf fs_opt "noatime" "xfs options"
+	fs_is_xfs=1
+	fs_is_btrfs=0
     fi
-    if [ -z "$fs_type" ]; then
-        # try to fallback to to old keys
-        get_conf tmp_devs "" "btrfs devs"
-        if [ -n "$tmp_devs" ]; then
-            fs_type="btrfs"
-        else
-            echo No filesystem type defined!
-            exit 1
-        fi
+    if [ -z "$fs_devs" ]; then
+        echo "no btrfs or xfs devs defined for $name"
+        exit 0
     fi
-
+ 
     first_dev=`echo $fs_devs | cut '-d ' -f 1`
-    get_conf fs_opt "" "osd mount options $fs_type"
+    [ -n "$fs_opt" ] && fs_opt="-o $fs_opt"
     if [ -z "$fs_opt" ]; then
         if [ "$fs_type" = "btrfs" ]; then
             #try to fallback to old keys
@@ -496,7 +498,6 @@ if [ $allhosts -eq 1 ]; then
 		cp $dir/conf /etc/ceph/ceph.conf
 	    fi
 	fi
-	
 	if [ $mkfs -eq 1 ] && [ "$type" = "osd" ]; then
 	    do_root_cmd "$0 -d $rdir --prepare-osdfs $name"
 	fi
